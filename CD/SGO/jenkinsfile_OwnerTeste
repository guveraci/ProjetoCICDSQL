thisBranch = env.BRANCH_NAME

pipeline {
    agent any
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }

    environment {
        ORACLE_HOME = "PATH"
        PATH = "$ORACLE_HOME/bin:$PATH"
    }

    stages {
        stage('Awaiting Approval') {
            steps {
/*                 script {
                    input(id: 'ApproveDeploy', message: 'Aprovação necessária para continuar.', submitter: 'helton', submitterParameter: 'APPROVED_BY')
                } */
                input 'Por favor aprovar o Deploy.'
            }
        }

        stage('Security pre-deploy') {
            steps {
                //script{
                //    secPreDeploy()
                //}
                sh 'echo "validação de segurança pré-cd"'
            }
        }

        stage('Artifact Directory Validation') {
            steps {
                dir('./devops/'){
                    script {
                        if (fileExists('.')) {
                            echo "Listando arquivos no diretório atual."
                            sh "ls -la"
                        } else {
                            echo "Diretório não encontrado."
                        }
                    }
                }
            }
        }

        stage('Base Validation') {
            steps {
                //Executar script para validar nome da base
                //sh 'cd ./devops/'
                //sh '&{ORACLE_HOME}/sqlplus system/Admin@123@localhost:1521 @select_globalname.sql'
                echo 'validando a base'     
            }
        }

        stage('Generate Backup') {
            steps {
                //Instalar Powershell Core no server
                //sh '/usr/bin/pwsh -File ./chamador-backup-GeradorDePacotes.ps1'
                echo "Gerando backup"
            }
        }

        stage('Generate artifact from backup') {
            steps {
                //Criar o artefato
                //compactar .zip
                //sh 'zip -r backup.zip /backup/'
                echo "Gerando artifact do backup"
            }
        }

        stage('Deploy') { 
/*             steps {
                sh 'cd ../${BUILD_NUMBER}'
                script{
                    if(env.BRANCH_NAME == 'main'){
                    sh '&{ORACLE_HOME}/sqlplus admindb/dboracle@localhost:1521 @chamador-*.sql'
                    }else if(env.BRANCH_NAME == 'homolog'){
                    sh '&{ORACLE_HOME}/sqlplus admindb/dboracle@localhost:1521 @chamador-*.sql'
                    }else if(env.BRANCH_NAME =~ /*){
                    sh '&{ORACLE_HOME}/sqlplus admindb/dboracle@localhost:1521 @chamador-*.sql'
                    }
                }
            } */
            steps {
                //executar chamadores para aplicar os sql
                //sh 'cd ../${BUILD_NUMBER}'
                //sh '&{ORACLE_HOME}/sqlplus admindb/dboracle@localhost:1521 @chamador-GeradorDePacotes-1.sql'
                echo "Aplicando alterações na base"
            }
        }

        stage('Object Validation') {
            /*             steps {
                sh 'cd ../${BUILD_NUMBER}'
                script{
                    if(env.BRANCH_NAME == 'main'){
                    sh '&{ORACLE_HOME}/sqlplus admindb/dboracle@localhost:1521 @script/script.sql'
                    }else if(env.BRANCH_NAME == 'homolog'){
                    sh '&{ORACLE_HOME}/sqlplus admindb/dboracle@localhost:1521 @script/script.sql'
                    }else if(env.BRANCH_NAME =~ /*){
                    sh '&{ORACLE_HOME}/sqlplus admindb/dboracle@localhost:1521 @script/script.sql'
                    }
                }
            } */
            steps {
                //sh '&{ORACLE_HOME}/sqlplus admindb/dboracle@localhost:1521 @script/script.sql'
                echo "validando objetos alterados"
            }
        }

        stage('Security post-deploy') {
            steps {
                //script{
                //    secPostDeploy()
                //}
                echo "Validação de segurança pós-CD"
            }
        }

        stage('Notification') {
            steps {
                /* script {
                    if (currentBuild.result == null || currentBuild.result == 'SUCCESS') {
                        emailext (
                            to: 'hpmsilva@mapfre.com.br',
                            subject: "Deploy bem sucedido"
                            body: """<p>Olá,</p><p>O Deploy foi realizado com sucesso no ambiente.</p><p>Atenciosamente,<br>Jenkins</p>""",
                            mimeType: 'text/html'
                        )
                    } else {
                        emailext (
                            to: 'hpmsilva@mapfre.com.br',
                            subject: "Deploy bem sucedido"
                            body: """<p>Olá,</p><p>Houve falha no Deploy.</p><p>Atenciosamente,<br>Jenkins</p>""",
                            mimeType: 'text/html'
                        )
                    }
                } */
                echo "enviando relatório"
            }
        }
    }
}